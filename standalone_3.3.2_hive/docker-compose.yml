---
x-docker-logging: &docker-logging
  logging:
    driver: "json-file"
    options:
      max-size: "10m"  # 로그 파일의 최대 크기 (10MB)
      max-file: "20"  # 유지할 로그 파일 개수 (최대 10개)

services:
  hive-metastore:
    <<: *docker-logging
    container_name: hive
    build: hive/dockerfile.d
    environment:
      DB_DRIVER: mysql
      SERVICE_NAME: metastore
      SERVICE_OPTS: >-
        -Djavax.jdo.option.ConnectionDriverName=com.mysql.cj.jdbc.Driver
        -Djavax.jdo.option.ConnectionURL=jdbc:mysql://mysql:3306/metastore?allowPublicKeyRetrieval=true&useSSL=false
        -Djavax.jdo.option.ConnectionUserName=root
        -Djavax.jdo.option.ConnectionPassword=example
    # volumes:
    #   - ./hive_log:/tmp/hive
    platform: linux/amd64
    ports:
      - 9083:9083
    depends_on:
      - mysql
      - minio

  spark-master:
    <<: *docker-logging
    container_name: spark-master
    build: spark/dockerfile.d
    volumes:
      # - ./spark_tmp:/tmp
      - ./spark_logs:/opt/spark/logs
      - ./spark_events:/opt/spark/events
    platform: linux/arm64
    user: '0'
    ports:
      - 4040:4040
      - 6066:6066
      - 7077-7082:7077-7082
      - 8080-8081:8080-8081
      - 10000:10000
      - 18080:18080
    depends_on:
      - hive-metastore
      - minio

  minio:
    container_name: minio
    build: minio/dockerfile.d
    ports:
      - 9000-9001:9000-9001
    healthcheck:
      test: ["CMD", "mc", "ready", "local"]
      interval: 10s
      retries: 5
      start_period: 5s
    volumes:
      - ./data:/data
    environment:
      - MINIO_ROOT_USER=admin
      - MINIO_ROOT_PASSWORD=admin1234

  mysql:
    container_name: mysql
    image: mysql:8.0.41
    volumes:
      - ./mysql:/var/lib/mysql
    environment:
      MYSQL_ROOT_PASSWORD: example
      MYSQL_DATABASE: metastore
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p$$MYSQL_ROOT_PASSWORD",
        ]
      interval: 10s
      retries: 5
      start_period: 5s
    restart: always

  broker:
    container_name: broker
    image: confluentinc/cp-kafka:latest
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_CLUSTER_ID: 5L6g3nShT-eMCtK--X86sw
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_CONTROLLER_QUORUM_VOTERS: "1@broker:29093"
      KAFKA_LISTENERS: "PLAINTEXT://broker:29092,CONTROLLER://broker:29093,PLAINTEXT_HOST://0.0.0.0:9092"
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://broker:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: 'CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT'
      KAFKA_DELETE_TOPIC_ENABLE: 'true'
    ports:
      - 9092:9092
  
  kafka-ui:
    container_name: kafka-ui
    image: provectuslabs/kafka-ui:latest
    ports:
      - 28080:8080
    depends_on:
      - broker
    environment:
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: broker:29092
